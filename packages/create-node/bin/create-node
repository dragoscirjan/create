#!/usr/bin/env node

import { program } from "commander";
import { resolve } from "path";
import logger from "../src/util/logger.js";
import { allBuildTools, allLanguages, allPackageManagers, allTestFrameworks, allQualityTools, allTargets, run } from "../src/index.js";

program
  .argument("<projectPath>", "Project Path")
  .option("-l, --language <language>", `Programming Language to use: ${allLanguages.join(", ")}`, "ts")
  .option("-t, --targets <targets...>", `Module's target: ${allTargets.join(", ")} or all`, "all")
  .option("--package-manager <packageManger>", `Package Manager to use: ${allPackageManagers.join(", ")}`, "npm")
  .option("--test-framework <testFramework>", `Testing Framework to use: ${allTestFrameworks.join(", ")}`, "jest")
  .option("--quality-tools <qualityTools...>", `Quality Tools to use: ${allQualityTools.join(", ")} or all`, "all")
  .option("--build-tool <buildTool>", `Build Tool to use: ${allBuildTools.join(", ")}`)
  .action(
    /**
     * @param projectPath {string}
     * @param options {{
          language: 'js' | 'ts' | 'coffee',
          packageManager: 'npm' | 'pnpm' | 'yarn',
          targets: string[],
          testFramework: 'ava' | 'deno' | 'mocha' | 'jasmine' | 'jest' | 'vitest',
          qualityTools: string[],
          projectPath: string
        }}
     */
    async (projectPath, options) => {
      options = {
        ...options,
        projectPath: resolve(projectPath),
        qualityTools: options.qualityTools === "all" ? allQualityTools : options.qualityTools,
        targets: options.targets === "all" || options.targets?.includes("all") ? allTargets : options.targets,
        logger,
      };
      // console.log(options);
      // process.exit(0);

      const { language, qualityTools, buildTool, testFramework, targets } = options;

      const runners = [
        // project init
        "package-json",

        // npm i
        "install",

        // deploy code
        "code",
        // deploy tests
        testFramework,
        `test-${testFramework}`,
        // deploy validate stuff
        "commitlint",
        "editorconfig",
        // deploy builder
        ...(language === "coffee" ? [] : []),
        ...(language === "js" || (language === "ts" && testFramework === "jasmine") ? ["babel"] : []),
        ...(language === "ts" ? ["tsc"] : []),
        ...(buildTool ? [buildTool] : []),
        // deploy target settings
        ...targets,
        // deploy quality tools
        ...qualityTools,
        "husky",
      ];
      for (const runner of runners) {
        await run(language, runner, options);
      }
    },
  )
  .parse();
